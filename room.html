<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  </head>
  <style media="screen">

    .pantalla {
      background-color: #253A6F;
      height: 30px;
      margin-bottom: 30px;
    }

    .asiento{
      margin: 3px;
      cursor: pointer;

      font-size: 13px;
      font-weight: bold;
      color: white;
      text-align: center;
    }
    .preview{
      height: 20px;
      width: 20px;
    }
    .ocupado {
      background-color: #215263;
    }

    .disponible {
      background-color: #3E7728;
    }
    .segundo{
      margin-top: 40px;
    }
    p {
      font-size: 18px;
      color: white;
      font-family: 'Lato', sans-serif;
    }

    button {
      margin-top: 20px;
    }
  </style>
  <body>
    <div id="app">

      <div class="container">
        <div class="pantalla" align="center">
          <p>Pantalla</p>
        </div>

        <!-- Asientos -->
        <div v-if="zonaA" class="row">
          <div class="col"></div>
          <div class="col-6">
            <div class="row justify-content-md-center">
              <div v-for="asiento in asientos[0]"
                    class="col col-sm-2 asiento"
                    v-bind:id="asiento.id" v-text="asiento.id"
                    @click="seleccionarAsiento"
                    v-bind:class="[(asiento.disponible) ? 'disponible' : 'ocupado']"
              >
              </div>
            </div>
          </div>
          <div class="col"></div>
        </div>

        <div class="row segundo">
          <div v-if="zonaB" class="col-3">
            <div class="row justify-content-md-center">
              <div v-for="asiento in asientos[1]"
                  class="col col-sm-4 asiento"
                  v-bind:id="asiento.id" v-text="asiento.id"
                  @click="seleccionarAsiento"
                  v-bind:class="[(asiento.disponible) ? 'disponible' : 'ocupado']">
              </div>
            </div>
          </div>
          <div class="col">
            <div  class="row justify-content-md-center">

              <div v-for="asiento in asientos[2]"
                class="col col-sm-2 asiento"
                v-bind:id="asiento.id" v-text="asiento.id"
                @click="seleccionarAsiento"
                v-bind:class="[(asiento.disponible) ? 'disponible' : 'ocupado']"
                >
              </div>
            </div>
          </div>
          <div v-if="zonaD" class="col-3">
            <div class="row justify-content-md-center">
              <div
                v-for="asiento in asientos[3]"
                class="col col-sm-4 asiento"
                v-bind:id="asiento.id" v-text="asiento.id"
                @click="seleccionarAsiento"
                v-bind:class="[(asiento.disponible) ? 'disponible' : 'ocupado']"
              ></div>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-info" @click="adquirirEntradas">Comprar</button>
        <button type="button" class="btn btn-danger" @click="liberarEntradas">Liberar</button>
        <hr>
          <div class="d-block">
            <strong class="d-inline">Disponible</strong>
            <div class="disponible preview"></div>
          </div>

          <div class="d-inline">
            <strong class="d-inline">Ocupado</strong>
            <div class="ocupado preview"></div>
          </div>
      </div>

    </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script src="https://www.gstatic.com/firebasejs/5.11.0/firebase.js"></script>

  <script>
    var config = {
      apiKey: "AIzaSyD0xjkGLxE0amB27oe1vAnvqwiaQ2cQYCo",
      authDomain: "democf-a6934.firebaseapp.com",
      databaseURL: "https://democf-a6934.firebaseio.com",
      projectId: "democf-a6934",
      storageBucket: "democf-a6934.appspot.com",
      messagingSenderId: "1053573094029"
    };

    firebase.initializeApp(config);
    let database = firebase.database()

    new Vue({
      el: "#app",

      created() {
        database.ref("/sala/" + this.nSala)
                .on('value', snapshot => this.cargarAsientos(snapshot.val()))
      },

      data: {
        nSala: 1,
        asientos: [],
      },

      methods: {
        adquirirEntradas: function(){
          this.pagarEntradas()

          database.ref("/sala/" + this.nSala).set(this.asientos).then(response => {
             alert("Entradas adquiridas!")
          })
        },

        seleccionarAsiento: function(event){
          for(let nFila in this.asientos){
            let asiento = this.asientos[nFila].find(asiento => asiento.id === event.target.id)

            if(asiento){
              if(asiento.purchased)
                alert("El asiento " + asiento.id + " no esta disponible")
              else
                asiento.disponible = !asiento.disponible
              break;
            }
          }
        },

        pagarEntradas: function() {
          for(let nFila in this.asientos){

            let fila  = this.asientos[nFila]
            let aSeleccionados = fila.filter(a => !a.disponible && !a.purchased)

            for(let nAsiento in aSeleccionados){
                fila.find(a => a.id === aSeleccionados[nAsiento].id).purchased = true
            }
          }
        },

        cargarAsientos: function(asientos){
          if (asientos === null) return

          this.asientos = []
          asientos.forEach((element) => this.asientos.push(element))
        },

        liberarEntradas: function(){
          this.asientos.forEach(function(element){
            element.forEach(function(asiento) {
              asiento.purchased = false
              asiento.disponible = true
            })
          });
          database.ref("/sala/" + this.nSala).set(this.asientos).then(response => {
             alert("Entradas liberadas!")
          })
        }
      },

      computed: {
        zonaA: function(){
          return true
        },

        zonaB: function(){
          return true
        },

        zonaC: function(){
          return true
        },

        zonaD: function(){
          return true
        },

      },
    })
  </script>


</html>
